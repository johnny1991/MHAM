#!/bin/bash

###################################### PARAMETERS ##############################################

. HA.conf
. $(dirname $0)/HA.conf

printer='script_perso'

echo -e "\033[32m $printer[info] Connexion en ssh a $ip_magento \033[0m"
echo -e "\033[32m $printer[info] lecture de l'adresse ip dans le local.xml \033[0m"

ip=$(sudo ssh -T root@$ip_magento "xmlstarlet sel -t -m '/config/global/resources/default_setup/connection' -v host $local_xml")

for (( i = 0; i < ${#ip_bdd[@]}; i++ )); do
    if [ ${ip_bdd[$i]} != $ip ]; then
        Slave_IO_Running=`mysql -h ${ip_bdd[$i]} -u $db_user -p$db_password $db_name -e 'SHOW SLAVE STATUS\G' | grep 'Slave_IO_Running' | awk -F': ' {'print $2'}`
        Slave_SQL_Running=`mysql -h ${ip_bdd[$i]} -u $db_user -p$db_password $db_name -e 'SHOW SLAVE STATUS\G' | grep 'Slave_SQL_Running'| awk -F': ' {'print $2'}`
        if [ -n "$Slave_IO_Running" ] && [ -n "$Slave_SQL_Running" ]; then
            if [ $Slave_IO_Running = No ] || [ $Slave_SQL_Running = No ]; then
                echo Probleme de synchronisation
                /bin/bash $script_path"synchronize --master=$ip --change_mha_conf=false"
            else
            	echo Aucun probleme de synchronisation
            fi
        else
        	echo La connexion a la bdd a echoue
        fi
    fi
done